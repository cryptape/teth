#!/usr/bin/env ruby

require 'erb'

ARGV << "--help" if ARGV.empty?

aliases = {
  "g"  => "generate",
  "t"  => "test",
  "n"  => "new"
}

command = ARGV.shift
command = aliases[command] || command

HELP_MESSAGE = <<-EOF
Usage: teth COMMAND [ARGS]
The most common teth commands are:
 generate    Generate new Smart Contract and test file (short-cut alias: "g")
 test        Run tests (short-cut alias: "t")
 new         Create a new Smart Contract application. "teth new my_app" creates a
             new application called MyApp in "./my_app"
All commands can be run with -h (or --help) for more information.
EOF

COMMAND_WHITELIST = %w(generate new help test)

CONTRACT_TEMPLATE = ERB.new <<-EOF
contract <%= name.capitalize %> {
}
EOF

TEST_TEMPLATE = ERB.new <<-EOF
require 'minitest/autorun'
require 'ethereum'
require 'json'

class <%=name.capitalize%>Test < Minitest::Test
  include Ethereum

  def setup
    @state = Tester::State.new
    @solidity_code = File.read('./contracts/<%= name.capitalize %>.sol')
    @c = @state.abi_contract @solidity_code, language: :solidity
  end
end
EOF

GEMFILE_TEMPLATE = ERB.new <<-EOF
gem 'teth', '>= 0.0.1'
EOF

def run_command!(command)
  command = parse_command(command)

  if COMMAND_WHITELIST.include?(command)
    send(command)
  else
    help
  end
end

def new
  name = ARGV.shift
  if name
    puts "Creating project #{name}..."
    system("mkdir #{name}")
    gemfile = GEMFILE_TEMPLATE.result(binding)
    File.open("#{name}/Gemfile", "w+") {|f| f.write(gemfile) }
    system("cd #{name} && mkdir contracts && mkdir tests && bundle install")
    puts "Done."
  else
    puts "Need project name"
  end
end

def generate
  name = ARGV.shift
  if name
    contract = CONTRACT_TEMPLATE.result(binding)
    puts "Create #{name.capitalize}.sol contract file..."
    File.open("contracts/#{name.capitalize}.sol", "w+") {|f| f.write(contract) }
    test = TEST_TEMPLATE.result(binding)
    puts "Create #{name}_test.rb test file..."
    File.open("tests/#{name.capitalize}_test.rb", "w+") {|f| f.write(test) }
    puts "Done."
  else
    puts "Need contract name!"
  end
end

def test
  name = ARGV.shift
  puts "Test #{name.capitalize} contract..."
  system("bundle exec ruby -Ilib:test tests/#{name}_test.rb")
  puts "Done."
end

def help
  write_help_message
end

def write_help_message
  puts HELP_MESSAGE
end

def parse_command(command)
  case command
  when "--help", "-h"
    "help"
  else
    command
  end
end

run_command!(command)
